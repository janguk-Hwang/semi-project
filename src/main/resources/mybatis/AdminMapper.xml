<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.AdminMapper">

    <!-- 검색 조건: WHERE 만들지 말고 AND 조건만 추가 -->
    <sql id="search">
        <if test="field != null and field != '' and keyword != null and keyword != ''">
            <choose>
                <when test="field == 'id'">
                    AND u.id LIKE '%' || #{keyword} || '%'
                </when>
                <when test="field == 'role'">
                    AND u.role LIKE '%' || #{keyword} || '%'
                </when>
            </choose>
        </if>
    </sql>

    <!-- 회원 목록 + 페이징 (검색조건 먼저 적용 후 row_number) -->
    <select id="userlist" resultType="UsersDto" parameterType="map">
        SELECT *
        FROM (
        SELECT
        u.*,
        ROW_NUMBER() OVER (ORDER BY u.member_id DESC) AS rnum
        FROM users u
        <where>
            1=1
            <include refid="search"/>
        </where>
        )
        WHERE rnum <![CDATA[ >= ]]> #{startRow}
        AND rnum <![CDATA[ <= ]]> #{endRow}
    </select>

    <!-- 회원 수 (검색조건 포함) -->
    <select id="count" resultType="int" parameterType="map">
        SELECT NVL(COUNT(*), 0)
        FROM users u
        <where>
            1=1
            <include refid="search"/>
        </where>
    </select>


    <select id="prev" parameterType="map" resultType="UsersDto">
        SELECT *
        FROM users
        WHERE member_id = (
        SELECT MAX(member_id)
        FROM users
        WHERE member_id <![CDATA[ < ]]> #{member_id}
        )
    </select>

    <select id="next" parameterType="map" resultType="UsersDto">
        SELECT *
        FROM users
        WHERE member_id = (
        SELECT MIN(member_id)
        FROM users
        WHERE member_id <![CDATA[ > ]]> #{member_id}
        )
    </select>

    <!-- admin 여부 체크 (가장 실용적인 형태: 존재하면 1, 없으면 0) -->
    <select id="isadmin" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM user_roles
        WHERE member_id = #{value}
        AND role = 'ADMIN'
    </select>

    <!-- 역할 변경 -->
    <update id="roleupdate" parameterType="UsersDto">
        UPDATE users
        SET role = #{role}
        WHERE member_id = #{member_id}
    </update>

    <!-- 회원 삭제 -->
    <delete id="admindelete" parameterType="int">
        DELETE FROM users
        WHERE member_id = #{value}
    </delete>

    <!-- 전체 회원 수 -->
    <select id="countmembers" resultType="int">
        SELECT COUNT(*) FROM users
    </select>

    <!-- 전체 게시글 수 -->
    <select id="countboard" resultType="int">
        SELECT COUNT(*) FROM board
    </select>
        <!-- =========================
             Board Management (fixed)
             ========================= -->

    <!-- 검색 조건 SQL 조각: WHERE를 만들지 말고 AND 조건만 추가 -->
    <sql id="boardSearch">
        <if test="field != null and field != '' and keyword != null and keyword != ''">
            <choose>
                <when test="field == 'title'">
                    AND b.title LIKE '%' || #{keyword} || '%'
                </when>
                <when test="field == 'content'">
                    AND b.content LIKE '%' || #{keyword} || '%'
                </when>
                <when test="field == 'id'">
                    AND u.id LIKE '%' || #{keyword} || '%'
                </when>
            </choose>
        </if>
    </sql>
    <select id="boardselectlist" resultType="String">
        select distinct board_type from board order by board_type
    </select>
    <!-- 목록 + 페이징 -->
    <select id="boardlist" resultType="BoardDto" parameterType="map">
        SELECT *
        FROM (
        SELECT
        b.*,
        ROW_NUMBER() OVER(ORDER BY b.board_id DESC) AS rnum
        FROM board b
        LEFT JOIN users u ON u.member_id = b.member_id
        <where>
            b.board_type = #{board_type}
            <include refid="boardSearch"/>
        </where>
        )
        WHERE rnum <![CDATA[ >= ]]> #{startRow}
        AND rnum <![CDATA[ <= ]]> #{endRow}
    </select>

    <!-- 관리자 목록 count -->
    <select id="board_management_count" resultType="int" parameterType="map">
        SELECT NVL(COUNT(*), 0)
        FROM board b
        LEFT JOIN users u ON u.member_id = b.member_id
        <where>
            b.board_type = #{board_type}
            <include refid="boardSearch"/>
        </where>
    </select>

    <!-- 이전글: 현재 글보다 작은 board_id 중 가장 큰 값 -->
    <select id="boardprev" parameterType="map" resultType="BoardDto">
        SELECT b.*
        FROM board b
        WHERE b.board_id = (
        SELECT MAX(b2.board_id)
        FROM board b2
        WHERE b2.board_type = #{board_type}
        AND b2.board_id <![CDATA[ < ]]> #{board_id}
        )
    </select>

    <!-- 다음글: 현재 글보다 큰 board_id 중 가장 작은 값 -->
    <select id="boardnext" parameterType="map" resultType="BoardDto">
        SELECT b.*
        FROM board b
        WHERE b.board_id = (
        SELECT MIN(b2.board_id)
        FROM board b2
        WHERE b2.board_type = #{board_type}
        AND b2.board_id <![CDATA[ > ]]> #{board_id}
        )
    </select>
    <select id="boardrequestlist" resultType="AdminBoardRequestDto" parameterType="map">
        SELECT *
        FROM (
        SELECT
        b.board_id,
        b.title,
        b.content,
        b.board_type,
        b.like_count,
        b.read_count,
        b.created_at,
        b.member_id,
        u.id AS id,
        ROW_NUMBER() OVER(ORDER BY b.board_id DESC) AS rnum
        FROM board b
        JOIN users u ON u.member_id = b.member_id
        <where>
            b.board_type = #{board_type}
            <include refid="boardSearch"/>
        </where>
        )
        WHERE rnum <![CDATA[ >= ]]> #{startRow}
        AND rnum <![CDATA[ <= ]]> #{endRow}
    </select>
    <delete id="adminboarddelete" parameterType="int">
    delete from board where board_id=#{value}
    </delete>

    <insert id="product_insert" parameterType="ProductDto">
        insert into product values(seq_product.nextVal,#{product_name},#{price},#{description},#{product_type},sysdate,#{artist_id})
    </insert>

    <insert id="stock_insert" parameterType="Stock_logDto">
        insert into product values(seq_stock_log.nextVal,#{change_type},#{quantity},sysdate,#{option_id})
    </insert>


</mapper>