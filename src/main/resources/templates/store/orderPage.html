<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <!-- 스크립트 추가 -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <link rel="stylesheet" th:href="@{/landing.css}">
    <title>store/orderPage.html</title>
    <style>
        .order-container{
            max-width: 900px;
            margin: 40px auto;
        }
        .order-box{
            background: #f9f9f9;
            padding: 30px;
            border-radius: 10px;
        }
        .order-section{
            margin-bottom: 30px;
        }
        .order-title{
            font-weight: bold;
            margin-bottom: 15px;
        }
        .order-product{
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .order-product img{
            width: 100px;
            border: 1px solid #ccc;
        }
        .order-summary{
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-weight: bold;
        }
        .order-input input{
            width: 100%;
            padding: 10px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<!-- 헤더삽입 -->
<div th:replace="~{fragments/layout::header}"></div>

<!-- 메인 콘텐츠 영역: th:block으로 감싸서 중복 출력을 방지합니다 -->
<th:block th:replace="~{fragments/layout::getMain(~{::content})}">
  <div th:fragment="content" class="order-container">
      <h2>ORDER</h2>
      <hr>
      <form method="post" th:action="@{/order/direct}">
          <div class="order-box">
              <!--주문상품-->
              <div class="order-section">
                  <div class="order-title">주문상품</div>
                  <div class="order-product">
<!--                      order.savefilename 에러 가드용 if-->
                      <img th:if="${order != null and order.savefilename != null}"
                           th:src="@{'/images/' + ${order.savefilename}}"
                           alt="대표이미지">

                      <div>
                          <p class="product-name" th:text="${order.product_name}">상품명</p>
                          <p class="product-option" th:if="${order.option_name!=null}" th:text="${order.option_name}">옵션명</p>
                          <p class="product-qty">
                              <span th:text="${order.quantity}">1</span>개 /
                          </p>
                          <p class="product-price">
                              <span th:text="${#numbers.formatInteger(order.total_price,0,'COMMA')}">0</span>원
                          </p>
                      </div>
                  </div>
                  <div class="order-summary">
                      <span>상품 합계</span>
                      <span th:text="${#numbers.formatInteger(order.total_price,0,'COMMA')}">0</span>원
                  </div>
              </div>
              <!--배송정보-->
              <div class="order-section">
                  <div class="order-title">배송 정보</div>
                  <div class="order-input">
                      <label>수령인</label>
                      <input type="text" name="receiver" th:value="${order.receiver}" required readonly>
                  </div>
                  <div class="order-input">
                      <label>연락처</label>
                      <input type="text" name="phone" th:value="${order.phone}" required pattern="[0-9]{10,11}" readonly>
                  </div>
                  <div class="order-input">
                      <label>배송지</label>
                      <input type="text" name="address" th:value="${order.address}" required>
                  </div>
              </div>

              <!--hidden값들-->
              <input type="hidden" name="product_id" th:value="${order.product_id}">
              <input type="hidden" name="option_id" th:value="${order.option_id}">
              <input type="hidden" name="quantity" th:value="${order.quantity}">
              <input type="hidden" name="price" th:value="${order.unit_price}">

              <button type="submit" class="order-btn" id="order-btn">결제하기</button>
              <button type="button" class="button" onclick="requestPayment()">결제창 열기</button>

          </div>
      </form>
  </div>
</th:block>

<!-- footer삽입 -->
<div th:replace="~{fragments/layout::footer}"></div>

<script th:inline="javascript">
    const amountValue = /*[[${order.total_price}]]*/ 0;
    const orderId = /*[[${order.order_id}]]*/ '';
    const orderName = /*[[${order.product_name}]]*/ '상품';
    const customername = /*[[${order.receiver}]]*/ '';
    const phone = /*[[${order.phone}]]*/ '';
    // ------  SDK 초기화 ------
    // @docs https://docs.tosspayments.com/sdk/v2/js#토스페이먼츠-초기화

    const clientKey = "test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq";
    const customerKey = "8KJYxJnpZ_jaKeeDIOIbI";
    const tossPayments = TossPayments(clientKey);
    // 회원 결제
    // @docs https://docs.tosspayments.com/sdk/v2/js#tosspaymentspayment
    const payment = tossPayments.payment({ customerKey });
    // 비회원 결제
    // const payment = tossPayments.payment({customerKey: TossPayments.ANONYMOUS})

    // ------ '결제하기' 버튼 누르면 결제창 띄우기 ------
    // @docs https://docs.tosspayments.com/sdk/v2/js#paymentrequestpayment
    async function requestPayment() {

        // 결제를 요청하기 전에 orderId, amount를 서버에 저장하세요.
        // 결제 과정에서 악의적으로 결제 금액이 바뀌는 것을 확인하는 용도입니다.
        await payment.requestPayment({
            method: "CARD", // 카드 결제
            amount: {
                currency: "KRW",
                value: amountValue,
            },
            orderId: orderId, // 고유 주문번호
            orderName: orderName,
            successUrl: window.location.origin + "/success", // 결제 요청이 성공하면 리다이렉트되는 URL
            failUrl: window.location.origin + "/fail", // 결제 요청이 실패하면 리다이렉트되는 URL
            customerEmail: "customer123@gmail.com",
            customerName: customername,
            customerMobilePhone: phone,
            // 카드 결제에 필요한 정보
            card: {
                useEscrow: false,
                flowMode: "DEFAULT", // 통합결제창 여는 옵션
                useCardPoint: false,
                useAppCardOnly: false,
            },
        });
    }
</script>
</body>
</html>